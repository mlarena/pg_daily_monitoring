{% extends "base.html" %}

{% block content %}
<h2>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>

{% if not connected %}
    <div class="alert alert-error">
        –°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL —Å–µ—Ä–≤–µ—Ä—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a href="{{ url_for('connect_to_postgres') }}">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Postgres</a>
    </div>
{% elif detailed_metrics %}
    {% if detailed_metrics.success %}
        <div class="info-box">
            <h3>–ü–æ–ª–Ω–∞—è –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <p>–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <p>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {{ detailed_metrics.database_name }}</p>
        </div>

        <div class="metrics-grid">
            <!-- –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="metric-card">
                <h3>üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                <div class="metric-value">{{ detailed_metrics.database_name }}</div>
                <div class="metric-description">–¢–µ–∫—É—â–∞—è –ë–î</div>
            </div>

            <div class="metric-card">
                <h3>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                <div class="metric-value">{{ detailed_metrics.current_user }}</div>
                <div class="metric-description">–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            </div>

            <div class="metric-card">
                <h3>üíæ –†–∞–∑–º–µ—Ä –ë–î</h3>
                <div class="metric-value">{{ "%.1f"|format(detailed_metrics.database_size_gb) }} GB</div>
                <div class="metric-description">{{ detailed_metrics.database_size_mb }} MB</div>
            </div>

            <div class="metric-card">
                <h3>‚è±Ô∏è Uptime</h3>
                <div class="metric-value">{{ "%.1f"|format(detailed_metrics.uptime_seconds / 3600) }} —á</div>
                <div class="metric-description">{{ "%.0f"|format(detailed_metrics.uptime_seconds) }} —Å–µ–∫</div>
            </div>

            <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
            <div class="metric-card">
                <h3>üîó –í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</h3>
                <div class="metric-value">{{ detailed_metrics.total_connections }}</div>
                <div class="metric-description">–ê–∫—Ç–∏–≤–Ω—ã—Ö: {{ detailed_metrics.active_connections }}</div>
            </div>

            <div class="metric-card">
                <h3>üí§ Idle –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                <div class="metric-value">{{ detailed_metrics.idle_connections }}</div>
                <div class="metric-description">–û–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
            </div>

            <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
            <div class="metric-card">
                <h3>‚úÖ –ö–æ–º–º–∏—Ç—ã</h3>
                <div class="metric-value">{{ detailed_metrics.total_commits | number_format }}</div>
                <div class="metric-description">–£—Å–ø–µ—à–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
            </div>

            <div class="metric-card">
                <h3>‚ùå –†–æ–ª–ª–±—ç–∫–∏</h3>
                <div class="metric-value">{{ detailed_metrics.total_rollbacks | number_format }}</div>
                <div class="metric-description">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
            </div>

            <div class="metric-card">
                <h3>üìä % –†–æ–ª–ª–±—ç–∫–æ–≤</h3>
                <div class="metric-value">{{ detailed_metrics.rollback_ratio }}%</div>
                <div class="metric-description">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞—Ç–æ–≤</div>
            </div>

            <!-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
            <div class="metric-card">
                <h3>üíæ –ß—Ç–µ–Ω–∏—è —Å –¥–∏—Å–∫–∞</h3>
                <div class="metric-value">{{ detailed_metrics.blocks_read | number_format }}</div>
                <div class="metric-description">–ë–ª–æ–∫–æ–≤ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
            </div>

            <div class="metric-card">
                <h3>üöÄ –ö–µ—à-–ø–æ–ø–∞–¥–∞–Ω–∏—è</h3>
                <div class="metric-value">{{ detailed_metrics.blocks_hit | number_format }}</div>
                <div class="metric-description">–ë–ª–æ–∫–æ–≤ –∏–∑ –∫–µ—à–∞</div>
            </div>

            <div class="metric-card">
                <h3>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ—à–∞</h3>
                <div class="metric-value">{{ detailed_metrics.cache_hit_ratio }}%</div>
                <div class="metric-description">–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π</div>
            </div>

            <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ -->
            <div class="metric-card">
                <h3>üì• –í—Å—Ç–∞–≤–∫–∏</h3>
                <div class="metric-value">{{ detailed_metrics.tuples_inserted | number_format }}</div>
                <div class="metric-description">–í—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫</div>
            </div>

            <div class="metric-card">
                <h3>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
                <div class="metric-value">{{ detailed_metrics.tuples_updated | number_format }}</div>
                <div class="metric-description">–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫</div>
            </div>

            <div class="metric-card">
                <h3>üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏—è</h3>
                <div class="metric-value">{{ detailed_metrics.tuples_deleted | number_format }}</div>
                <div class="metric-description">–£–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫</div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
        <div class="info-box">
            <h3>–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <table class="metrics-table">
                <tr>
                    <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                    <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                </tr>
                <tr>
                    <td>–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</td>
                    <td><strong>{{ detailed_metrics.database_name }}</strong></td>
                </tr>
                <tr>
                    <td>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</td>
                    <td>{{ detailed_metrics.current_user }}</td>
                </tr>
                <tr>
                    <td>–°–µ—Ä–≤–µ—Ä</td>
                    <td>{{ detailed_metrics.server_address }}:{{ detailed_metrics.server_port }}</td>
                </tr>
                <tr>
                    <td>–†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</td>
                    <td>{{ "%.2f"|format(detailed_metrics.database_size_gb) }} GB ({{ detailed_metrics.database_size_mb }} MB)</td>
                </tr>
                <tr>
                    <td>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</td>
                    <td>{{ "%.1f"|format(detailed_metrics.uptime_seconds / 3600) }} —á–∞—Å–æ–≤</td>
                </tr>
                <tr>
                    <td>–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</td>
                    <td>{{ detailed_metrics.total_connections }}</td>
                </tr>
                <tr>
                    <td>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</td>
                    <td>{{ detailed_metrics.active_connections }}</td>
                </tr>
                <tr>
                    <td>Idle –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</td>
                    <td>{{ detailed_metrics.idle_connections }}</td>
                </tr>
                <tr>
                    <td>–ö–æ–º–º–∏—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td>
                    <td>{{ detailed_metrics.total_commits | number_format }}</td>
                </tr>
                <tr>
                    <td>–û—Ç–∫–∞—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td>
                    <td>{{ detailed_metrics.total_rollbacks | number_format }}</td>
                </tr>
                <tr>
                    <td>–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞—Ç–æ–≤</td>
                    <td>{{ detailed_metrics.rollback_ratio }}%</td>
                </tr>
                <tr>
                    <td>–ß—Ç–µ–Ω–∏—è —Å –¥–∏—Å–∫–∞</td>
                    <td>{{ detailed_metrics.blocks_read | number_format }}</td>
                </tr>
                <tr>
                    <td>–ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫–µ—à</td>
                    <td>{{ detailed_metrics.blocks_hit | number_format }}</td>
                </tr>
                <tr>
                    <td>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ—à–∞</td>
                    <td>{{ detailed_metrics.cache_hit_ratio }}%</td>
                </tr>
                <tr>
                    <td>–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ —Å—Ç—Ä–æ–∫</td>
                    <td>{{ detailed_metrics.tuples_returned | number_format }}</td>
                </tr>
                <tr>
                    <td>–ü–æ–ª—É—á–µ–Ω–æ —Å—Ç—Ä–æ–∫</td>
                    <td>{{ detailed_metrics.tuples_fetched | number_format }}</td>
                </tr>
                <tr>
                    <td>–í—Å—Ç–∞–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫</td>
                    <td>{{ detailed_metrics.tuples_inserted | number_format }}</td>
                </tr>
                <tr>
                    <td>–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫</td>
                    <td>{{ detailed_metrics.tuples_updated | number_format }}</td>
                </tr>
                <tr>
                    <td>–£–¥–∞–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫</td>
                    <td>{{ detailed_metrics.tuples_deleted | number_format }}</td>
                </tr>
                <tr>
                    <td>Shared buffers</td>
                    <td>{{ detailed_metrics.shared_buffers }}</td>
                </tr>
                <tr>
                    <td>Work memory</td>
                    <td>{{ detailed_metrics.work_mem }}</td>
                </tr>
                <tr>
                    <td>Maintenance work memory</td>
                    <td>{{ detailed_metrics.maintenance_work_mem }}</td>
                </tr>
            </table>
        </div>

    {% else %}
        <div class="alert alert-error">
            –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {{ detailed_metrics.error }}
        </div>
    {% endif %}
{% else %}
    <div class="alert alert-error">
        –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    </div>
{% endif %}
{% endblock %}