{% extends "base.html" %}

{% block content %}
{% macro render_table(tables, table_stats) %}
<table class="stats-table">
    <thead>
        <tr>
            <th class="sortable" data-column="table_name" 
                onmouseenter="showTooltip(event, 'table_name')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('table_name')">
                –¢–∞–±–ª–∏—Ü–∞ 
                {% if table_stats.sort_by == 'table_name' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="sequential_scans"
                onmouseenter="showTooltip(event, 'sequential_scans')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('sequential_scans')">
                –ü–æ—Å–ª. —Å–∫–∞–Ω—ã
                {% if table_stats.sort_by == 'sequential_scans' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="seq_rows_read"
                onmouseenter="showTooltip(event, 'seq_rows_read')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('seq_rows_read')">
                –°—Ç—Ä–æ–∫ –ø–æ—Å–ª.
                {% if table_stats.sort_by == 'seq_rows_read' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="index_scans"
                onmouseenter="showTooltip(event, 'index_scans')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('index_scans')">
                –ò–Ω–¥–µ–∫—Å —Å–∫–∞–Ω—ã
                {% if table_stats.sort_by == 'index_scans' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="index_rows_fetched"
                onmouseenter="showTooltip(event, 'index_rows_fetched')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('index_rows_fetched')">
                –°—Ç—Ä–æ–∫ –∏–Ω–¥.
                {% if table_stats.sort_by == 'index_rows_fetched' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="index_scan_ratio"
                onmouseenter="showTooltip(event, 'index_scan_ratio')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('index_scan_ratio')">
                % –ò–Ω–¥–µ–∫—Å
                {% if table_stats.sort_by == 'index_scan_ratio' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="inserts"
                onmouseenter="showTooltip(event, 'inserts')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('inserts')">
                –í—Å—Ç–∞–≤–∫–∏
                {% if table_stats.sort_by == 'inserts' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="updates"
                onmouseenter="showTooltip(event, 'updates')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('updates')">
                –û–±–Ω–æ–≤–ª–µ–Ω–∏—è
                {% if table_stats.sort_by == 'updates' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="deletes"
                onmouseenter="showTooltip(event, 'deletes')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('deletes')">
                –£–¥–∞–ª–µ–Ω–∏—è
                {% if table_stats.sort_by == 'deletes' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="hot_updates"
                onmouseenter="showTooltip(event, 'hot_updates')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('hot_updates')">
                HOT –æ–±–Ω.
                {% if table_stats.sort_by == 'hot_updates' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="live_rows"
                onmouseenter="showTooltip(event, 'live_rows')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('live_rows')">
                –ñ–∏–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
                {% if table_stats.sort_by == 'live_rows' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="dead_rows"
                onmouseenter="showTooltip(event, 'dead_rows')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('dead_rows')">
                –ú–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
                {% if table_stats.sort_by == 'dead_rows' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
            <th class="sortable" data-column="dead_row_ratio"
                onmouseenter="showTooltip(event, 'dead_row_ratio')" 
                onmouseleave="hideTooltip()"
                onclick="sortTable('dead_row_ratio')">
                % –ú–µ—Ä—Ç–≤—ã—Ö
                {% if table_stats.sort_by == 'dead_row_ratio' %}
                    {{ '‚ñº' if table_stats.sort_order == 'desc' else '‚ñ≤' }}
                {% endif %}
            </th>
        </tr>
    </thead>
    <tbody>
        {% for table in tables %}
        <tr class="{{ 'high-dead-rows' if table.dead_row_ratio > 10 else '' }}">
            <td class="table-name">
                {% if not table_stats.group_by_schema %}
                    <span class="schema-badge">{{ table.schemaname }}.</span>
                {% endif %}
                {{ table.table_name }}
            </td>
            <td class="number">{{ table.sequential_scans | number_format }}</td>
            <td class="number">{{ table.seq_rows_read | number_format }}</td>
            <td class="number">{{ table.index_scans | number_format }}</td>
            <td class="number">{{ table.index_rows_fetched | number_format }}</td>
            <td class="number {{ 'low-index-usage' if table.index_scan_ratio < 50 else 'good-index-usage' }}">
                {{ "%.1f"|format(table.index_scan_ratio) }}%
            </td>
            <td class="number">{{ table.inserts | number_format }}</td>
            <td class="number">{{ table.updates | number_format }}</td>
            <td class="number">{{ table.deletes | number_format }}</td>
            <td class="number">{{ table.hot_updates | number_format }}</td>
            <td class="number">{{ table.live_rows | number_format }}</td>
            <td class="number {{ 'warning' if table.dead_rows > 1000 else '' }}">
                {{ table.dead_rows | number_format }}
            </td>
            <td class="number {{ 'critical' if table.dead_row_ratio > 20 else 'warning' if table.dead_row_ratio > 10 else '' }}">
                {{ "%.1f"|format(table.dead_row_ratio) }}%
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endmacro %}

<h2>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º</h2>

{% if not connected %}
    <div class="alert alert-error">
        –°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL —Å–µ—Ä–≤–µ—Ä—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a href="{{ url_for('connect_to_postgres') }}">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Postgres</a>
    </div>
{% elif table_stats %}
    {% if table_stats.success %}
        <div class="info-box">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <p>–í—Å–µ–≥–æ —Ç–∞–±–ª–∏—Ü: {{ table_stats.total_tables }}</p>
            <p class="small-info">
                –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: {{ table_stats.sort_by }} ({{ table_stats.sort_order }})
                | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: <span id="grouping-status">{{ '–í–ö–õ' if table_stats.group_by_schema else '–í–´–ö–õ' }}</span>
                | –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                | –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
            </p>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="control-panel">
            <div class="control-group">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                <select id="sort-select" onchange="changeSorting()">
                    <option value="dead_rows" {% if table_stats.sort_by == 'dead_rows' %}selected{% endif %}>–ú–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏</option>
                    <option value="live_rows" {% if table_stats.sort_by == 'live_rows' %}selected{% endif %}>–ñ–∏–≤—ã–µ —Å—Ç—Ä–æ–∫–∏</option>
                    <option value="sequential_scans" {% if table_stats.sort_by == 'sequential_scans' %}selected{% endif %}>–ü–æ—Å–ª. —Å–∫–∞–Ω—ã</option>
                    <option value="index_scans" {% if table_stats.sort_by == 'index_scans' %}selected{% endif %}>–ò–Ω–¥–µ–∫—Å —Å–∫–∞–Ω—ã</option>
                    <option value="inserts" {% if table_stats.sort_by == 'inserts' %}selected{% endif %}>–í—Å—Ç–∞–≤–∫–∏</option>
                    <option value="updates" {% if table_stats.sort_by == 'updates' %}selected{% endif %}>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</option>
                    <option value="table_name" {% if table_stats.sort_by == 'table_name' %}selected{% endif %}>–ò–º—è —Ç–∞–±–ª–∏—Ü—ã</option>
                    <option value="schemaname" {% if table_stats.sort_by == 'schemaname' %}selected{% endif %}>–°—Ö–µ–º–∞</option>
                </select>
                
                <select id="order-select" onchange="changeSorting()">
                    <option value="desc" {% if table_stats.sort_order == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                    <option value="asc" {% if table_stats.sort_order == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                </select>
            </div>
            
            <div class="control-group">
                <button class="btn" onclick="toggleGrouping()" id="grouping-btn">
                    {{ '–í—ã–∫–ª—é—á–∏—Ç—å' if table_stats.group_by_schema else '–í–∫–ª—é—á–∏—Ç—å' }} –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É
                </button>
                <button class="btn" onclick="toggleAllGroups()" id="toggle-all-btn" {% if not table_stats.group_by_schema %}style="display: none;"{% endif %}>
                    –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ
                </button>
                <button class="btn" onclick="resetSorting()">–°–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</button>
            </div>
        </div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–∞—è -->
        <div id="column-tooltip" class="column-tooltip">
            <div class="tooltip-default">
                <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</strong><br>
                –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –ª—é–±–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏
            </div>
            <div class="tooltip-content" style="display: none;"></div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –∏–ª–∏ –±–µ–∑ -->
        <div class="table-container">
            {% if table_stats.group_by_schema %}
                <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ö–µ–º–∞–º -->
                {% set grouped_tables = {} %}
                {% for table in table_stats.tables %}
                    {% set schema = table.schemaname %}
                    {% if schema not in grouped_tables %}
                        {% set _ = grouped_tables.update({schema: []}) %}
                    {% endif %}
                    {% set _ = grouped_tables[schema].append(table) %}
                {% endfor %}

                {% for schema, tables_in_schema in grouped_tables.items() %}
                <div class="schema-group" data-schema="{{ schema }}">
                    <div class="schema-header" onclick="toggleSchema('{{ schema }}')">
                        <span class="toggle-icon">‚ñ∂</span>
                        <strong>{{ schema }}</strong>
                        <span class="schema-stats">
                            (—Ç–∞–±–ª–∏—Ü: {{ tables_in_schema|length }}, 
                            –∂–∏–≤—ã—Ö —Å—Ç—Ä–æ–∫: {{ tables_in_schema | sum(attribute='live_rows') | number_format }},
                            –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫: {{ tables_in_schema | sum(attribute='dead_rows') | number_format }})
                        </span>
                    </div>
                    
                    <div class="schema-content" id="schema-{{ schema }}" style="display: none;">
                        {{ render_table(tables_in_schema, table_stats) }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- –ë–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ - –ø–ª–æ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
                {{ render_table(table_stats.tables, table_stats) }}
            {% endif %}
        </div>

        <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
        <div class="info-box">
            <h4>–õ–µ–≥–µ–Ω–¥–∞:</h4>
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color critical"></span>
                    <span>–í—ã—Å–æ–∫–∏–π % –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫ (>20%) - —Ç—Ä–µ–±—É–µ—Ç—Å—è VACUUM</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color warning"></span>
                    <span>–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π % –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫ (10-20%) - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è VACUUM</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color low-index-usage"></span>
                    <span>–ù–∏–∑–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (<50%)</span>
                </div>
            </div>
        </div>

        <!-- JavaScript –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º -->
        <script>
            // –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            let currentSortBy = '{{ table_stats.sort_by }}';
            let currentSortOrder = '{{ table_stats.sort_order }}';
            let currentGroupBySchema = {{ 'true' if table_stats.group_by_schema else 'false' }};
            
            // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤
            const columnDescriptions = {
                'table_name': '–ò–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö',
                'sequential_scans': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã (–ø–æ–ª–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã)',
                'seq_rows_read': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö',
                'index_scans': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–¥–µ–∫—Å–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã',
                'index_rows_fetched': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã',
                'index_scan_ratio': '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å—ã. –ù–∏–∑–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (<50%) –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã',
                'inserts': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π INSERT',
                'updates': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π UPDATE',
                'deletes': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π DELETE',
                'hot_updates': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ HOT (Heap Only Tuple) –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫',
                'live_rows': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ "–∂–∏–≤—ã—Ö" (–∞–∫—Ç–∏–≤–Ω—ã—Ö) —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ',
                'dead_rows': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ "–º–µ—Ä—Ç–≤—ã—Ö" —Å—Ç—Ä–æ–∫ (—É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö), –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç VACUUM',
                'dead_row_ratio': '–ü—Ä–æ—Ü–µ–Ω—Ç –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫. –í—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (>10%) —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å VACUUM'
            };
            
           // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    function showTooltip(event, column) {
        const tooltip = document.getElementById('column-tooltip');
        const defaultContent = tooltip.querySelector('.tooltip-default');
        const tooltipContent = tooltip.querySelector('.tooltip-content');
        const description = columnDescriptions[column] || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏
        defaultContent.style.display = 'none';
        tooltipContent.style.display = 'block';
        tooltipContent.innerHTML = `<strong>${event.target.textContent.trim()}</strong><br>${description}`;
        
        tooltip.style.display = 'block';
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Ä—è–¥–æ–º —Å –∫—É—Ä—Å–æ—Ä–æ–º
        const x = event.pageX + 10;
        const y = event.pageY + 10;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –ø–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
        const tooltipRect = tooltip.getBoundingClientRect();
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        let finalX = x;
        let finalY = y;
        
        // –ï—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Å–ª–µ–≤–∞ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
        if (x + tooltipRect.width > windowWidth - 20) {
            finalX = event.pageX - tooltipRect.width - 10;
        }
        
        // –ï—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –≤—ã—à–µ –∫—É—Ä—Å–æ—Ä–∞
        if (y + tooltipRect.height > windowHeight - 20) {
            finalY = event.pageY - tooltipRect.height - 10;
        }
        
        tooltip.style.left = finalX + 'px';
        tooltip.style.top = finalY + 'px';
        
        // –£–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        tooltip.style.bottom = 'auto';
        tooltip.style.right = 'auto';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
    function hideTooltip() {
        const tooltip = document.getElementById('column-tooltip');
        const defaultContent = tooltip.querySelector('.tooltip-default');
        const tooltipContent = tooltip.querySelector('.tooltip-content');
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        tooltipContent.style.display = 'none';
        defaultContent.style.display = 'block';
        
        // –û—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫ –≤–∏–¥–∏–º—ã–º, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –º–µ—Å—Ç–æ
        tooltip.style.display = 'block';
        tooltip.style.left = '20px';
        tooltip.style.top = 'auto';
        tooltip.style.bottom = '20px';
        tooltip.style.right = '20px';
    }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            function changeSorting() {
                const sortBy = document.getElementById('sort-select').value;
                const sortOrder = document.getElementById('order-select').value;
                
                updateURL({ sort_by: sortBy, sort_order: sortOrder });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            function sortTable(column) {
                let newSortOrder = 'desc';
                
                if (currentSortBy === column) {
                    newSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
                }
                
                updateURL({ sort_by: column, sort_order: newSortOrder });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
            function toggleGrouping() {
                updateURL({ group_by_schema: !currentGroupBySchema });
            }
            
            // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            function resetSorting() {
                updateURL({ sort_by: 'dead_rows', sort_order: 'desc' });
            }
            
            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–∞–º–∏
            function toggleSchema(schema) {
                const content = document.getElementById('schema-' + schema);
                const icon = content.previousElementSibling.querySelector('.toggle-icon');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    icon.textContent = '‚ñ∂';
                }
            }
            
            function toggleAllGroups() {
                const allContents = document.querySelectorAll('.schema-content');
                const allIcons = document.querySelectorAll('.toggle-icon');
                
                const isAnyOpen = Array.from(allContents).some(content => content.style.display !== 'none');
                
                allContents.forEach(content => {
                    content.style.display = isAnyOpen ? 'none' : 'block';
                });
                
                allIcons.forEach(icon => {
                    icon.textContent = isAnyOpen ? '‚ñ∂' : '‚ñº';
                });
            }
            
            // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è URL
            function updateURL(params) {
                const url = new URL(window.location.href);
                
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined) {
                        url.searchParams.set(key, params[key]);
                    } else {
                        url.searchParams.delete(key);
                    }
                });
                
                window.location.href = url.toString();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            document.addEventListener('DOMContentLoaded', function() {
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É
                hideTooltip();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ö–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
                if (currentGroupBySchema) {
                    const firstSchema = document.querySelector('.schema-group');
                    if (firstSchema) {
                        toggleSchema(firstSchema.dataset.schema);
                    }
                }
            });
        </script>

    {% else %}
        <div class="alert alert-error">
            –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–∞–±–ª–∏—Ü: {{ table_stats.error }}
        </div>
    {% endif %}
{% else %}
    <div class="alert alert-error">
        –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–∞–±–ª–∏—Ü
    </div>
{% endif %}
{% endblock %}